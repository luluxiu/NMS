<#include "../../../layout/header.html" >

<div class="pageheader">
  <h2><i class="fa fa-tasks"></i>模板</h2>
  <div class="breadcrumb-wrapper">
    <ol class="breadcrumb">
      <li class="active">模板</li>
    </ol>
  </div>
</div><!-- pageheader -->


<!-- main content -->
<div class="contentpanel">
  <div class="row">
    <div class="col-md-12">
      <p class="toolbar">
        <a class="create btn btn-success" href="javascript:" >
          <i class="fa fa-plus">&nbsp;&nbsp;</i>添加
        </a>
        <span class="alert"></span>
      </p>

      <table id="table" class="table table-no-bordered table-inverse" data-show-refresh="true"
        data-show-columns="true" data-striped="true" data-show-toggle="true"
        data-query-params-type="" data-query-params="queryParams" data-toolbar=".toolbar"
        data-page-list="[10, 20, 50]" data-pagination="true" data-side-pagination="server"
        data-search='true' data-search-time-out='3000' data-trim-on-search='true'
        data-search-on-enter-key='true'>
        <thead>
          <th data-formatter="runningFormatter">No.</th>
          <th data-field="id" data-align="center" data-visible="false">ID</th>
          <th data-field="templateName" data-align="center" data-sortable="true">名称</th>
          <th data-field="templateDescription" data-align="center" data-visible="false">描述</th>
          <th data-field="updatedAt" data-align="center" data-visible="true" data-sortable="true"
            data-sort-order="desc">更新时间</th>
          <th data-field="createdAt" data-align="center" data-visible="false" data-sortable="true"
            data-sort-order="desc">创建时间</th>
          <th data-field="action" data-align="center" data-formatter="actionFormatter" data-events="actionEvents">操作</th>
        </thead>
      </table>

      <div class="row">
        <div id="modal" class="modal fade">
          <div class="modal-dialog">
            <div class="modal-content">
              <form class="form-horizontal m-t required-validate" id="config" autocomplete="off" novalidate="novalidate">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                  <h4 class="modal-title"></h4>
                </div>
                <div class="modal-body form-horizontal m-t required-validate">

                  <div class="form-group">
                    <label class="col-sm-3 control-label">模板名</label>
                    <div class="col-sm-7">
                      <input type="text" name="templateName" class="form-control" />
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="col-sm-3 control-label">模板说明</label>
                    <div class="col-sm-7">
                      <input type="text" name="templateDescription" class="form-control" />
                    </div>
                  </div>

                  <div class="form-group">
                    <label class="col-sm-3 control-label">协议</label>
                    <div class="col-sm-7">
                      <select name="protocol" class="form-control">
                        <option value="dhcp" selected>DHCP</option>
                        <option value="static">STATIC</option>
                        <option value="pppoe">PPPOE</option>
                        <option value="3g">3/4G</option>
                      </select>
                    </div>
                  </div>

                  <!-- static -->
                  <div class="form-group2" id="static">
                    <div class="form-group">
                      <label class="col-sm-3 control-label">IP</label>
                      <div class="col-sm-7">
                        <input type="text" name="address" class="form-control" />
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-sm-3 control-label">子网掩码</label>
                      <div class="col-sm-7">
                        <input type="text" name="netmask" class="form-control" />
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-sm-3 control-label">网关</label>
                      <div class="col-sm-7">
                        <input type="text" name="gateway" class="form-control" />
                      </div>
                    </div>
                  </div>

                  <!-- pppoe -->
                  <div class="form-group2" id="pppoe">
                    <div class="form-group">
                      <label class="col-sm-3 control-label">用户名</label>
                      <div class="col-sm-7">
                        <input type="text" name="username" class="form-control" />
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-sm-3 control-label">密码</label>
                      <div class="col-sm-7">
                        <input type="text" name="password" class="form-control" />
                      </div>
                    </div>
                  </div>

                  <!-- 3/4g -->
                  <div class="form-group2" id="3a4g">
                    <div class="form-group">
                      <label class="col-sm-3 control-label">调制解调器节点</label>
                      <div class="col-sm-7">
                        <input type="text" name="modemDevice" class="form-control" />
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-sm-3 control-label">服务类型</label>
                      <div class="col-sm-7" class="form-control">
                        <select name="serviceType" class="form-control">
                          <option value="auto">自动</option>
                          <option value="lte_only">仅LTE</option>
                          <option value="umts_only">仅UMTS(WCDMA)</option>
                          <option value="gprs_only">仅GPRS</option>
                          <option value="evdo">CDMA/EV-DO</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-sm-3 control-label">APN</label>
                      <div class="col-sm-7">
                        <input type="text" name="APN" class="form-control" />
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-sm-3 control-label">Dial Number</label>
                      <div class="col-sm-7">
                        <input type="text" name="dialNumber" class="form-control" />
                      </div>
                    </div>
                  </div>

                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                  <button type="button" class="btn btn-primary submit">提交</button>
                </div>
              </form>
            </div><!-- /.modal-content -->
          </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
      </div><!-- /.row -->
    </div>
  </div>
</div><!-- main content -->

<script type="text/javascript">
  var TEMPLATE_WAN_BASE = "${viewHelper.getPath()}/device/ap/template/wan";
  var TEMPLATE_WAN_SHOW = TEMPLATE_WAN_BASE + "/show";
  var TEMPLATE_WAN_EDIT = TEMPLATE_WAN_BASE + "/edit";
  var TEMPLATE_WAN_DEL = TEMPLATE_WAN_BASE + "/delete";

  var _csrf = "${_csrf.token ?if_exists}";
  var $alert = $('.alert').hide();
  var $modal = $('#modal').modal({show: false});
  var $table = $('#table').bootstrapTable({
    sortOrder: "desc",
    url: TEMPLATE_WAN_SHOW,
    formatShowingRows : formatShowingRows,
    formatRecordsPerPage : formatRecordsPerPage
  })


  $(function() {

    $table.on('post-body.bs.table', function () {
      var $search = $table.data('bootstrap.table')
        .$toolbar.find('.search input');
      $search.attr('placeholder', '根据模板名字搜索 ...');
    });

    $('.create').click(function() {
      showModal($(this).text());
    });

    //wan
    $("select[name='protocol']").change(function() {
      switch($("select[name='protocol']").val()) {
        case "dhcp":
          $("#pppoe").hide();
          $("#static").hide();
          $("#3a4g").hide();
          break;

        case "static":
          $("#static").show();
          $("#pppoe").hide();
          $("#3a4g").hide();
          break;

        case "pppoe":
          $("#static").hide();
          $("#pppoe").show();
          $("#3a4g").hide();
          break;

        case "3g":
          $("#pppoe").hide();
          $("#static").hide();
          $("#3a4g").show();
          break;

        default:
          break;
      }
    })


    $modal.find('.submit').click(function() {
      var data;
      var title;
      var url;

      if($modal.data('id') && $modal.data('id') >=0) {
        data = $("#config").serialize() + "&id=" + $modal.data('id') + '&_csrf=' + _csrf;
        url = TEMPLATE_WAN_EDIT;
        title = "修改";
      }
      else {
        data = $("#config").serialize() + '&_csrf=' + _csrf;
        url = TEMPLATE_WAN_BASE;
        title = "添加";
      }
      $.ajax({
        url: url,
        type: 'post',
        data: data,
        success: function (result) {
          if(result.result == "success") {
            $modal.modal('hide');
            $table.bootstrapTable('refresh');
            showAlert(title + '成功!', 'success');
          }
          else {
            $modal.modal('hide');
            showAlert(title + '失败! ' + result.msg, 'danger');
          }
        },
        error: function () {
          $modal.modal('hide');
          showAlert(title + '失败!', 'danger');
        }
      });
    });

  });


  window.actionEvents = {
    'click .update': function (e, value, row) {
      showModal("修改", row);
    },
    'click .remove': function (e, value, row) {
      if (confirm('确定要删除这一项吗?')) {
        var data = "id=" + row.id + "&_csrf=" + _csrf;
        $.ajax({
          url: TEMPLATE_WAN_DEL,
          type: 'post',
          data: data,
          success: function (result) {
            if(result.result == "success") {
              $table.bootstrapTable('refresh');
              showAlert('删除成功!', 'success');
            }
            else {
              showAlert('删除错误!' + result.msg, 'danger');
            }
          },
          error: function () {
            showAlert('删除错误!', 'danger');
          }
        })
      }
    }
  };

  function showModal(title, row) {
    row = row || {
        protocol: 'dhcp',
        address: '',
        netmask: '',
        gateway: '',
        username: '',
        password: '',
        modemDevice: '',
        serviceType: 'auto',
        APN: '',
        dialNumber: '',
        templateName: '',
        templateDescription: ''
      };

    if(typeof(row.id) == "undefined") {
      $modal.data('id', -1);
    }
    else if(row.id >= 0){
      $modal.data('id', row.id);
      $modal.find('input[name][type="text"]').each(function () {
        $(this).val("");
      });
    }

    $modal.find('.modal-title').text(title);
    for (var name in row) {
      $modal.find('input[name="' + name + '"][type="text"]').val(row[name]);
    }

    $("select[name='protocol']").val(row['protocol']).change();
    $("select[name='serviceType']").val(row['serviceType']);

    $modal.modal('show');
  }


  /* static */
  function actionFormatter(value) {
    return [
      '<div class="btn-group" role="group">',
      '<a class="btn btn-primary btn-xs update" href="javascript:"><i class="fa fa-cog">&nbsp;&nbsp;</i>修改</a>',
      '<a class="btn btn-danger btn-xs remove " href="javascript:"><i class="fa fa-trash">&nbsp;&nbsp;</i>删除</a>',
      '</div>'
    ].join('');
  }

  function queryParams(params) {
    return {
      page: params.pageNumber,
      size: params.pageSize,
      sortName: params.sortName || "updatedAt",
      sortOrder: params.sortOrder || "desc",
      search: params.searchText,
      _r: Math.floor(Math.random()*10000)
    };
  }

  /* alert */
  function showAlert(title, type) {
    $alert.attr('class', 'alert alert-' + type || 'success').html('<i class="fa fa-check"></i> ' + title).show();
    setTimeout(function(){$alert.hide();}, 3000);
  }

  /* page formatter */
  function formatRecordsPerPage(pageNumber) {
    return '&nbsp;' + pageNumber + ' 每页';
  }

  function formatShowingRows(pageFrom, pageTo, totalRows) {
    return '共 ' + totalRows + ' 项记录';
  }

  function runningFormatter(value, row, index) {
    return index + 1;
  }
  /* page formatter - end */

</script>

<#include "../../../layout/footer.html" >
